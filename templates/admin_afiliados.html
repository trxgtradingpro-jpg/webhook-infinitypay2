<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Afiliados • Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg:#050816; --panel:#0b132b; --border:#1d2a52; --txt:#e5ecff; --muted:#94a3b8; --cyan:#38bdf8; --green:#22c55e; --red:#f87171; --amber:#f59e0b; }
        *{box-sizing:border-box}
        body{margin:0;font-family:'Inter',sans-serif;color:var(--txt);background:radial-gradient(circle at 10% 10%,#12244f 0%,transparent 40%),radial-gradient(circle at 90% 0%,#1f1155 0%,transparent 35%),var(--bg);padding:clamp(12px,2.5vw,24px)}
        .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:12px;flex-wrap:wrap}
        .title{font-size:28px;font-weight:800}
        .menu{display:flex;gap:10px;flex-wrap:wrap}
        .menu a,.menu button{padding:10px 16px;border-radius:999px;border:1px solid var(--border);text-decoration:none;color:var(--txt);background:rgba(255,255,255,.02);transition:.2s;cursor:pointer;font:inherit}
        .menu a.active,.menu a:hover,.menu button:hover{border-color:var(--cyan);box-shadow:0 0 20px rgba(56,189,248,.2);transform:translateY(-1px)}
        .menu form{margin:0}
        .panel{background:linear-gradient(180deg,rgba(15,24,52,.95),rgba(10,16,35,.95));border:1px solid var(--border);border-radius:14px;padding:16px}
        .panel + .panel{margin-top:14px}
        .panel-title{font-size:16px;font-weight:800;margin:0 0 12px}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
        label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
        input{width:100%;background:#08112a;border:1px solid var(--border);color:var(--txt);border-radius:10px;padding:10px 12px}
        .inline-check{display:flex;align-items:center;gap:8px;margin-top:8px;color:var(--txt);font-size:13px}
        .inline-check input{width:auto;padding:0}
        .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:12px}
        button,.btn-link{background:#0a1734;border:1px solid var(--border);color:var(--cyan);border-radius:10px;padding:10px 14px;text-decoration:none;cursor:pointer}
        .btn-danger{color:var(--red)}
        .btn-ok{color:var(--green)}
        .msg{margin-bottom:14px;padding:10px 12px;border-radius:10px;border:1px solid var(--border)}
        .msg.ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#bbf7d0}
        .msg.err{background:rgba(248,113,113,.12);border-color:rgba(248,113,113,.35);color:#fecaca}
        .tip{font-size:12px;color:var(--muted);margin-top:6px}
        .table-wrap{width:100%;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#0a1328}
        table{width:max-content;min-width:100%;border-collapse:collapse}
        th,td{padding:10px;border-bottom:1px solid #16244a;text-align:left;vertical-align:top;font-size:13px;white-space:normal;overflow-wrap:anywhere;word-break:break-word}
        th{color:var(--muted);font-weight:600;position:sticky;top:0;background:#071126;z-index:1}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
        .status{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700}
        .status.on{background:rgba(34,197,94,.16);color:#86efac}
        .status.off{background:rgba(248,113,113,.16);color:#fecaca}
        .row-actions{display:flex;gap:8px;flex-wrap:wrap;min-width:260px}
        .link{color:var(--cyan);text-decoration:none;word-break:break-all}
        @media (max-width: 900px){
            .title{font-size:22px}
            .topbar{align-items:flex-start}
            th,td{font-size:12px;padding:9px}
            .row-actions{min-width:220px}
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="title">✨ Painel Admin — Afiliados</div>
        <nav class="menu">
            <a href="/admin/dashboard">Resumo</a>
            <a href="/admin/relatorios">Relatórios</a>
            <a href="/dashboard">Gráficos</a>
            <a href="/admin/analytics">Analytics</a>
            <a class="active" href="/admin/afiliados">Afiliados</a>
            <button type="button" id="backupNowBtn">Backup agora</button>
            <form method="POST" action="/admin/logout">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit">Sair</button>
            </form>
        </nav>
    </div>

    {% if msg %}
        <div class="msg {{ 'ok' if ok else 'err' }}">{{ msg }}</div>
    {% endif %}

    <section class="panel">
        <h2 class="panel-title">Adicionar afiliado</h2>
        <form method="POST" action="/admin/afiliados/adicionar">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="form-grid">
                <div>
                    <label for="novo_nome">Nome</label>
                    <input id="novo_nome" name="nome" type="text" required placeholder="Ex.: Alessio Silva">
                </div>
                <div>
                    <label for="novo_slug">Slug</label>
                    <input id="novo_slug" name="slug" type="text" placeholder="Ex.: alessio" pattern="[a-z0-9-]{2,60}">
                    <div class="tip">Somente letras minúsculas, números e hífen.</div>
                </div>
                <div>
                    <label for="novo_email">E-mail</label>
                    <input id="novo_email" name="email" type="email" placeholder="alessio@email.com">
                </div>
                <div>
                    <label for="novo_telefone">Telefone</label>
                    <input id="novo_telefone" name="telefone" type="text" placeholder="11999999999">
                </div>
            </div>
            <label class="inline-check"><input type="checkbox" name="ativo" value="1" checked> Afiliado ativo</label>
            <div class="actions">
                <button type="submit" class="btn-ok">Adicionar afiliado</button>
            </div>
        </form>
    </section>

    <section class="panel">
        <h2 class="panel-title">Lista de afiliados</h2>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Slug</th>
                        <th>Nome</th>
                        <th>Status</th>
                        <th>Link público</th>
                        <th>Checkout ref</th>
                        <th>Contato</th>
                        <th>Atualização</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in afiliados %}
                    <tr>
                        <td class="mono">{{ a.slug }}</td>
                        <td>{{ a.nome }}</td>
                        <td>
                            {% if a.ativo %}
                                <span class="status on">Ativo</span>
                            {% else %}
                                <span class="status off">Inativo</span>
                            {% endif %}
                        </td>
                        <td>
                            <a class="link" href="{{ base_url }}/{{ a.slug }}" target="_blank" rel="noopener noreferrer">{{ base_url }}/{{ a.slug }}</a>
                        </td>
                        <td>
                            <div class="mono">trx-gratis-{{ a.slug }}</div>
                            <div class="mono">trx-prata-{{ a.slug }}</div>
                        </td>
                        <td>
                            <div>{{ a.email or '-' }}</div>
                            <div>{{ a.telefone or '-' }}</div>
                        </td>
                        <td>{{ a.updated_at.strftime("%d/%m/%Y %H:%M") if a.updated_at else '-' }}</td>
                        <td>
                            <form method="POST" action="/admin/afiliados/{{ a.slug }}/editar" class="row-actions">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <input type="text" name="slug" value="{{ a.slug }}" required pattern="[a-z0-9-]{2,60}" title="Somente letras minúsculas, números e hífen">
                                <input type="text" name="nome" value="{{ a.nome }}" required>
                                <input type="email" name="email" value="{{ a.email or '' }}" placeholder="E-mail">
                                <input type="text" name="telefone" value="{{ a.telefone or '' }}" placeholder="Telefone">
                                <label class="inline-check"><input type="checkbox" name="ativo" value="1" {% if a.ativo %}checked{% endif %}> Ativo</label>
                                <button type="submit" class="btn-ok">Salvar</button>
                            </form>
                            <form method="POST" action="/admin/afiliados/{{ a.slug }}/excluir" onsubmit="return confirm('Excluir afiliado {{ a.slug }}?');" style="margin-top:8px;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="submit" class="btn-danger">Excluir</button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="8" style="color:#94a3b8">Nenhum afiliado cadastrado ainda.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    <script>
        const backupBtn = document.getElementById('backupNowBtn');
        if (backupBtn) {
            backupBtn.addEventListener('click', async () => {
                backupBtn.disabled = true;
                backupBtn.textContent = 'Gerando backup...';
                try {
                    const r = await fetch('/admin/backup/agora', {
                        method: 'POST',
                        headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
                    });
                    const d = await r.json();
                    alert(d.message || (d.ok ? 'Backup concluido.' : 'Falha ao gerar backup.'));
                } catch (e) {
                    alert('Falha ao acionar backup.');
                } finally {
                    backupBtn.disabled = false;
                    backupBtn.textContent = 'Backup agora';
                }
            });
        }
    </script>
</body>
</html>
