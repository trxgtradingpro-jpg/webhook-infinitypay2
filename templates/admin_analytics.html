<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics • Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/admin-theme.css?v=20260216">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <main class="admin-shell">
    <div class="topbar">
      <div>
        <div class="title">Painel Admin | Analytics</div>
        <p class="title-sub">Analise temporal de pedidos e faturamento com filtros dinamicos.</p>
      </div>
      <nav class="menu">
        <a href="/admin/dashboard">Resumo</a>
        <a href="/admin/health">Saude</a>
        <a href="/admin/relatorios">Relatorios</a>
        <a href="/dashboard">Graficos</a>
        <a class="active" href="/admin/analytics">Analytics</a>
        <a href="/admin/afiliados">Afiliados</a>
        <button type="button" id="backupNowBtn">Backup agora</button>
        <form method="POST" action="/admin/logout">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button class="danger" type="submit">Sair</button>
        </form>
      </nav>
    </div>

    <section class="panel">
      <div class="filters">
        <div>
          <label for="start">Data inicial</label>
          <input id="start" type="date" value="{{ inicio_padrao }}">
        </div>
        <div>
          <label for="end">Data final</label>
          <input id="end" type="date" value="{{ hoje }}">
        </div>
        <div>
          <label class="inline-check" style="margin-top:24px;"><input id="noEnd" type="checkbox"> Sem data final</label>
        </div>
        <div>
          <label for="chartType">Tipo de grafico</label>
          <select id="chartType">
            <option value="line">Linha</option>
            <option value="area">Area</option>
            <option value="bar">Barras</option>
            <option value="doughnut">Donut</option>
          </select>
        </div>
        <div>
          <label for="metric">Metrica</label>
          <select id="metric">
            <option value="revenue">Faturamento</option>
            <option value="orders_total">Pedidos</option>
            <option value="orders_paid">Pedidos pagos</option>
            <option value="orders_free">Pedidos gratis</option>
            <option value="orders_by_plan">Por plano</option>
          </select>
        </div>
        <div>
          <label for="plan">Plano</label>
          <select id="plan">
            <option value="all">Todos</option>
            {% for p in planos %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label for="groupBy">Agrupar por</label>
          <select id="groupBy">
            <option value="day">Dia</option>
            <option value="week">Semana</option>
            <option value="month">Mes</option>
          </select>
        </div>
        <div class="actions">
          <button id="applyBtn" type="button">Aplicar</button>
        </div>
      </div>

      <div class="row" id="summaryCards">
        <div class="card"><div class="k">Total usuarios</div><div class="v" id="totalUsers">0</div></div>
        <div class="card"><div class="k">Total gratis</div><div class="v" id="totalFree">0</div></div>
        <div class="card"><div class="k">Total pagos</div><div class="v" id="totalPaid">0</div></div>
        <div class="card"><div class="k">Faturamento</div><div class="v" id="totalRevenue">R$ 0,00</div></div>
      </div>
    </section>

    <section class="panel chart-wrap">
      <canvas id="chart"></canvas>
    </section>
  </main>

  <script>
    let chart;

    function formatBRL(cents) {
      return (cents / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    async function carregarResumo(params) {
      const url = '/api/analytics/summary?' + new URLSearchParams(params).toString();
      const r = await fetch(url);
      if (!r.ok) return;
      const d = await r.json();
      document.getElementById('totalUsers').textContent = d.total_users;
      document.getElementById('totalFree').textContent = d.total_free;
      document.getElementById('totalPaid').textContent = d.total_paid;
      document.getElementById('totalRevenue').textContent = formatBRL(d.revenue_total || 0);
    }

    async function carregarGrafico() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('noEnd').checked ? '' : document.getElementById('end').value;
      const metric = document.getElementById('metric').value;
      const chartType = document.getElementById('chartType').value;
      const groupBy = document.getElementById('groupBy').value;
      const plan = document.getElementById('plan').value;

      const params = { start, metric, chartType, groupBy, plan };
      if (end) params.end = end;

      await carregarResumo({ start, end });

      const url = '/api/analytics/chart?' + new URLSearchParams(params).toString();
      const resp = await fetch(url);
      if (!resp.ok) return;
      const payload = await resp.json();

      const datasets = payload.series.map((serie, idx) => ({
        label: serie.name,
        data: serie.data.map((p) => ({ x: p.x, y: p.y })),
        borderWidth: 2,
        pointRadius: 3,
        tension: 0.35,
        fill: chartType === 'area',
        backgroundColor: [
          'rgba(35,176,11,.24)',
          'rgba(74,163,255,.28)',
          'rgba(255,138,31,.25)',
          'rgba(255,106,106,.24)',
          'rgba(255,210,26,.22)'
        ][idx % 5],
        borderColor: ['#23b00b', '#4aa3ff', '#ff8a1f', '#ff6a6a', '#ffd21a'][idx % 5]
      }));

      let finalType = chartType;
      if (chartType === 'area') finalType = 'line';

      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('chart'), {
        type: finalType,
        data: { datasets },
        options: {
          parsing: false,
          maintainAspectRatio: false,
          scales: {
            x: { type: 'category', ticks: { color: 'rgba(228,239,250,.8)' }, grid: { color: 'rgba(206,222,241,.12)' } },
            y: { ticks: { color: 'rgba(228,239,250,.8)' }, grid: { color: 'rgba(206,222,241,.12)' } }
          },
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              labels: {
                color: 'rgba(238,246,255,.92)',
                boxWidth: 14,
                boxHeight: 14
              }
            },
            tooltip: {
              callbacks: {
                label(ctx) {
                  const v = ctx.raw?.y ?? 0;
                  if (metric === 'revenue') return `${ctx.dataset.label}: ${formatBRL(v)}`;
                  return `${ctx.dataset.label}: ${v}`;
                }
              }
            }
          }
        }
      });
    }

    document.getElementById('noEnd').addEventListener('change', (e) => {
      document.getElementById('end').disabled = e.target.checked;
    });

    document.getElementById('applyBtn').addEventListener('click', carregarGrafico);
    carregarGrafico();

    const backupBtn = document.getElementById('backupNowBtn');
    if (backupBtn) {
      backupBtn.addEventListener('click', async () => {
        backupBtn.disabled = true;
        backupBtn.textContent = 'Gerando backup...';
        try {
          const r = await fetch('/admin/backup/agora', {
            method: 'POST',
            headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
          });
          const d = await r.json();
          alert(d.message || (d.ok ? 'Backup concluído.' : 'Falha ao gerar backup.'));
        } catch (e) {
          alert('Falha ao acionar backup.');
        } finally {
          backupBtn.disabled = false;
          backupBtn.textContent = 'Backup agora';
        }
      });
    }
  </script>
</body>
</html>
