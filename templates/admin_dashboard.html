<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Resumo • Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/admin-theme.css?v=20260216">
</head>
<body>
  <main class="admin-shell">
    <div class="topbar">
      <div>
        <div class="title">Painel Admin | Resumo</div>
        <p class="title-sub">Visão geral de pedidos, status e operação comercial.</p>
      </div>
      <nav class="menu">
        <a class="active" href="/admin/dashboard">Resumo</a>
        <a href="/admin/relatorios">Relatórios</a>
        <a href="/dashboard">Gráficos</a>
        <a href="/admin/analytics">Analytics</a>
        <a href="/admin/afiliados">Afiliados</a>
        <button type="button" id="backupNowBtn">Backup agora</button>
        <form method="POST" action="/admin/logout">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button class="danger" type="submit">Sair</button>
        </form>
      </nav>
    </div>

    <div class="stats">
      <div class="card"><div class="label">Total pedidos</div><div class="value">{{ stats.total_pedidos }}</div></div>
      <div class="card"><div class="label">Processados (pagos reais)</div><div class="value">{{ stats.processados }}</div></div>
      <div class="card"><div class="label">Pendentes</div><div class="value">{{ stats.pendentes }}</div></div>
      <div class="card"><div class="label">Total pagos</div><div class="value">{{ stats.pagos }}</div></div>
      <div class="card"><div class="label">Total grátis</div><div class="value">{{ stats.total_gratis }}</div></div>
      <div class="card"><div class="label">Faturamento total</div><div class="value">{{ stats.total_faturado }}</div></div>
      <div class="card"><div class="label">Online agora</div><div class="value" id="online-count">{{ stats.online }}</div></div>
    </div>

    <section class="panel">
      <form class="filters" method="GET" action="/admin/dashboard">
        <div>
          <label for="filtro-busca">Busca geral</label>
          <input id="filtro-busca" type="text" name="q" value="{{ busca or '' }}" placeholder="Buscar por nome, email, telefone, plano, afiliado, checkout...">
        </div>
        <div>
          <label for="filtro-plano">Filtro de plano</label>
          <select id="filtro-plano" name="plano">
            <option value="todos" {% if filtro_plano == 'todos' %}selected{% endif %}>Todos</option>
            <option value="pagos" {% if filtro_plano == 'pagos' %}selected{% endif %}>Somente pagos</option>
            <option value="gratis" {% if filtro_plano == 'gratis' %}selected{% endif %}>Somente grátis</option>
            <option value="pendentes" {% if filtro_plano == 'pendentes' %}selected{% endif %}>Somente pendentes</option>
            {% for plano in planos %}
              <option value="{{ plano }}" {% if filtro_plano == plano %}selected{% endif %}>{{ plano }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="actions">
          <button type="submit">Filtrar</button>
          {% if busca or filtro_plano != 'todos' %}<a class="btn-chip" href="/admin/dashboard">Limpar</a>{% endif %}
        </div>
      </form>
    </section>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Pedido</th>
            <th>Nome</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>Plano</th>
            <th>Afiliado</th>
            <th>Checkout ref</th>
            <th>Status</th>
            <th>Data</th>
            <th>Dias p/30</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for p in pedidos %}
            <tr>
              <td><span class="mono no-wrap">{{ p.order_id[:8] }}...</span></td>
              <td>{{ p.nome_masked or '-' }}</td>
              <td>{{ p.email_masked or '-' }}</td>
              <td>{{ p.telefone_masked or '-' }}</td>
              <td>
                {% if p.plano == 'trx-bronze' %}<span class="plan bronze">TRX BRONZE</span>
                {% elif p.plano == 'trx-prata' %}<span class="plan prata">TRX PRATA</span>
                {% elif p.plano == 'trx-gold' %}<span class="plan gold">TRX GOLD</span>
                {% elif p.plano == 'trx-black' %}<span class="plan black">TRX BLACK</span>
                {% elif p.plano == 'trx-gratis' %}<span class="plan gratis">TRX GRATIS</span>
                {% elif p.plano == 'trx-teste' %}<span class="plan teste">TRX TESTE</span>
                {% else %}<span class="plan">{{ p.plano }}</span>{% endif %}
              </td>
              <td>
                {% if p.affiliate_slug %}
                  <div class="aff-name">{{ p.affiliate_nome or p.affiliate_slug }}</div>
                  <div class="muted mono">/{{ p.affiliate_slug }}</div>
                  {% if p.affiliate_email_masked %}<div class="muted">{{ p.affiliate_email_masked }}</div>{% endif %}
                {% else %}
                  <span class="muted">Direto</span>
                {% endif %}
              </td>
              <td><span class="mono">{{ p.checkout_slug or p.plano }}</span></td>
              <td>
                {% if p.status == 'PAGO' and p.plano == 'trx-gratis' %}
                  <span class="okfree">Pago (gratis)</span>
                {% elif p.status == 'PAGO' %}
                  <span class="ok">Pago</span>
                {% elif p.status == 'PROCESSANDO' %}
                  <span class="pend">Processando</span>
                {% else %}
                  <span class="pend">Pendente</span>
                {% endif %}
              </td>
              <td>{{ p.created_at_local }}</td>
              <td>
                {% if p.dias_restantes_30 is none %}
                  -
                {% elif p.dias_restantes_30 <= 0 %}
                  <span class="expired">encerrado</span>
                {% elif p.dias_restantes_30 in [5,3] %}
                  <span class="alert">faltam {{ p.dias_restantes_30 }} dias</span>
                {% else %}
                  {{ p.dias_restantes_30 }} dias
                {% endif %}
              </td>
              <td class="actions-cell">
                <a href="/admin/pedido/{{ p.order_id }}">Ver</a>
                {% if p.whatsapp_link %}
                  | <form method="POST" action="/admin/whatsapp/{{ p.order_id }}" class="actions-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" class="btn-link">WhatsApp</button>
                  </form>
                {% endif %}
                {% if p.whatsapp_status %} | <span class="muted">{{ p.whatsapp_status }}</span>{% endif %}
                {% if p.tem_duplicados %}
                  <br><span class="alert">{{ p.duplicados_total }} duplicado(s)</span>
                  <form method="POST" action="/admin/pedido/{{ p.order_id }}/excluir-duplicados" class="actions-inline" onsubmit="return confirm('Excluir os duplicados deste cadastro e manter este?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="nome" value="{{ p.nome or '' }}">
                    <input type="hidden" name="email" value="{{ p.email or '' }}">
                    <input type="hidden" name="telefone" value="{{ p.telefone or '' }}">
                    <button type="submit" class="btn-link">Excluir duplicados</button>
                  </form>
                {% endif %}
                | <form method="POST" action="/admin/pedido/{{ p.order_id }}/excluir" class="actions-inline" onsubmit="return confirm('Tem certeza que deseja excluir este pedido?');"><input type="hidden" name="csrf_token" value="{{ csrf_token }}"><button type="submit" class="btn-link-danger">Excluir</button></form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>

  <script>
    async function atualizarOnline() {
      try {
        const r = await fetch('/admin/online-count');
        if (!r.ok) return;
        const d = await r.json();
        const el = document.getElementById('online-count');
        if (el) el.textContent = d.online;
      } catch (e) {}
    }
    atualizarOnline();
    setInterval(atualizarOnline, 10000);

    const backupBtn = document.getElementById('backupNowBtn');
    if (backupBtn) {
      backupBtn.addEventListener('click', async () => {
        backupBtn.disabled = true;
        backupBtn.textContent = 'Gerando backup...';
        try {
          const r = await fetch('/admin/backup/agora', {
            method: 'POST',
            headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
          });
          const d = await r.json();
          alert(d.message || (d.ok ? 'Backup concluído.' : 'Falha ao gerar backup.'));
        } catch (e) {
          alert('Falha ao acionar backup.');
        } finally {
          backupBtn.disabled = false;
          backupBtn.textContent = 'Backup agora';
        }
      });
    }
  </script>
</body>
</html>
