<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatorios â€¢ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/admin-theme.css?v=20260216">
</head>
<body>
  <main class="admin-shell">
    <div class="topbar">
      <div>
        <div class="title">Painel Admin | Relatorios</div>
        <p class="title-sub">Resumo consolidado por plano com monitoramento em tempo real.</p>
      </div>
      <nav class="menu">
        <a href="/admin/dashboard">Resumo</a>
        <a class="active" href="/admin/relatorios">Relatorios</a>
        <a href="/dashboard">Graficos</a>
        <a href="/admin/analytics">Analytics</a>
        <a href="/admin/afiliados">Afiliados</a>
        <button type="button" id="backupNowBtn">Backup agora</button>
        <form method="POST" action="/admin/logout">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <button class="danger" type="submit">Sair</button>
        </form>
      </nav>
    </div>

    <div class="cards">
      <div class="card"><div class="label">Total pedidos</div><div class="value">{{ stats.total_pedidos }}</div></div>
      <div class="card"><div class="label">Pagos reais</div><div class="value">{{ stats.pagos_reais }}</div></div>
      <div class="card"><div class="label">Pendentes</div><div class="value">{{ stats.pendentes }}</div></div>
      <div class="card"><div class="label">Faturado total</div><div class="value">{{ stats.faturado_total }}</div></div>
      <div class="card"><div class="label">Online agora</div><div class="value" id="online-count">{{ stats.online }}</div></div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Plano</th>
            <th>Quantidade (PAGO)</th>
            <th>Faturado</th>
          </tr>
        </thead>
        <tbody>
          {% for row in por_plano %}
            <tr>
              <td>{{ row.nome }} <small class="muted">({{ row.plano_id }})</small></td>
              <td>{{ row.quantidade }}</td>
              <td>{{ row.faturado }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>

  <script>
    async function atualizarOnline() {
      try {
        const r = await fetch('/admin/online-count');
        if (!r.ok) return;
        const d = await r.json();
        const el = document.getElementById('online-count');
        if (el) el.textContent = d.online;
      } catch (e) {}
    }
    atualizarOnline();
    setInterval(atualizarOnline, 10000);

    const backupBtn = document.getElementById('backupNowBtn');
    if (backupBtn) {
      backupBtn.addEventListener('click', async () => {
        backupBtn.disabled = true;
        backupBtn.textContent = 'Gerando backup...';
        try {
          const r = await fetch('/admin/backup/agora', {
            method: 'POST',
            headers: { 'X-CSRF-Token': '{{ csrf_token }}' }
          });
          const d = await r.json();
          alert(d.message || (d.ok ? 'Backup concluido.' : 'Falha ao gerar backup.'));
        } catch (e) {
          alert('Falha ao acionar backup.');
        } finally {
          backupBtn.disabled = false;
          backupBtn.textContent = 'Backup agora';
        }
      });
    }
  </script>
</body>
</html>
