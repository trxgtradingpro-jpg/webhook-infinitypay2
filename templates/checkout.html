<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>{{ "Ativar acesso grátis" if is_free_plan else "Finalizar compra" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #f4f6f8, #eef2f6);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .checkout-container {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 14px;
      padding: 32px 28px;
      box-shadow: 0 20px 45px rgba(0,0,0,0.12);
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .badge-secure {
      background: #eafaf1;
      color: #1e8449;
      font-size: 13px;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      margin-bottom: 20px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      color: #2c3e50;
      text-align: center;
    }

    .subtitle {
      margin-top: 8px;
      font-size: 14px;
      color: #7f8c8d;
      text-align: center;
      margin-bottom: 24px;
    }

    label {
      display: block;
      margin-top: 14px;
      font-size: 14px;
      font-weight: 500;
      color: #34495e;
    }

    input {
      width: 100%;
      margin-top: 6px;
      padding: 14px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #dcdfe3;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #27ae60;
      box-shadow: 0 0 0 3px rgba(39,174,96,0.12);
    }

    .info {
      font-size: 13px;
      color: #7f8c8d;
      margin-top: 6px;
    }

    button {
      margin-top: 26px;
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      transition: transform 0.15s, box-shadow 0.15s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(39,174,96,0.3);
    }

    button:disabled {
      opacity: .7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Footer (seu) */
    .site-footer { margin-top: 18px; text-align: center; }

    .site-trust-grid { margin-top: 22px; display: grid; gap: 8px; }

    .site-trust-item {
      border: 1px solid #d8e2ea;
      background: #f7fafc;
      border-radius: 10px;
      padding: 10px 12px;
      text-align: left;
    }

    .site-trust-item strong {
      display: block;
      font-size: 13px;
      font-weight: 900;
      color: #0f172a;
    }

    .site-trust-item span {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: #64748b;
      font-weight: 700;
      line-height: 1.35;
    }

    .site-seals {
      margin-top: 14px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      text-align: center;
    }

    .site-seals span {
      border: 1px solid #d8e0e7;
      background: #f4f7fa;
      border-radius: 999px;
      padding: 8px 11px;
      font-size: 12px;
      font-weight: 800;
      color: #334155;
    }

    .security-badge-wrap {
      margin: 10px auto 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .security-badge-img {
      width: min(220px, 72vw);
      margin: 0;
      display: block;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
    }

    .security-badge-secondary { margin-top: 0; display: block; }

    .security-badge-seal {
      width: min(88px, 24vw);
      display: block;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
    }

    .site-legal {
      margin-top: 6px;
      font-size: 12px;
      color: #64748b;
      font-weight: 700;
    }

    .site-copy {
      margin-top: 10px;
      font-size: 20px;
      font-weight: 900;
      color: #0f172a;
    }

    .site-rights { margin-top: 6px; font-size: 13px; color: #64748b; }

    .site-links {
      margin-top: 12px;
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .site-links a {
      color: #334155;
      text-decoration: none;
      font-size: 13px;
      font-weight: 700;
    }

    .site-links a:hover { color: #0f172a; }

    /* evita imagens/selos estourarem */
    .site-footer img,
    .site-footer svg,
    .security-badge-wrap img,
    .security-badge-wrap svg {
      max-width: 100%;
      height: auto;
    }

    /* ===== FIX FOOTER (checkout) - reduzir tamanho e espaçamento horizontal ===== */
    .site-footer{
      max-width: 360px;
      margin: 18px auto 0;
    }

    .site-trust-grid{
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .site-seals{ gap: 6px; }

    .site-seals span{
      padding: 6px 10px;
      font-size: 11px;
    }

    .security-badge-wrap{ gap: 8px; }

    .security-badge-img{ width: 160px; }

    .security-badge-seal{ width: 62px; }

    .site-copy{ font-size: 18px; }

    .site-links{ gap: 10px; }

    .site-links a{ font-size: 12px; }

    @media (max-width: 420px) {
      .checkout-container { padding: 26px 18px; border-radius: 12px; }
      h1 { font-size: 22px; }

      /* ainda menor no celular */
      .site-footer{ max-width: 320px; }
      .security-badge-img{ width: 145px; }
      .security-badge-seal{ width: 56px; }
    }
  </style>
</head>

<body>
  <div class="checkout-container">

    <div class="badge-secure">
      {{ "Ambiente seguro - Ativação do TRX Grátis" if is_free_plan else "Ambiente seguro - Pagamento processado pela InfinitePay" }}
    </div>

    <h1>{{ "Ativar acesso grátis" if is_free_plan else "Finalizar compra" }}</h1>

    <p class="subtitle">
      {{ "Preencha seus dados para liberar o TRX Grátis imediatamente" if is_free_plan else "Preencha seus dados para liberar o acesso imediatamente" }}
    </p>

    {% if affiliate %}
      <p class="subtitle" style="margin-top:-10px;margin-bottom:14px;">
        Indicação: <strong>{{ affiliate.nome }}</strong> ({{ affiliate.slug }})
      </p>
    {% endif %}

    <form id="checkout-form" method="POST" action="/comprar" novalidate>
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="hidden" name="plano" value="{{ plano }}">

      <label for="nome">Nome completo</label>
      <input
        id="nome"
        type="text"
        name="nome"
        placeholder="Digite seu nome completo"
        value="{{ nome }}"
        autocomplete="name"
        required
      />

      <label for="email">E-mail</label>
      <input
        id="email"
        type="email"
        name="email"
        placeholder="Seu e-mail"
        value="{{ email }}"
        autocomplete="email"
        required
      />
      <div class="info">O acesso será enviado para este e-mail</div>

      <label for="telefone">WhatsApp</label>
      <input
        id="telefone"
        type="tel"
        name="telefone"
        placeholder="Ex: 11 99999-9999"
        value="{{ telefone }}"
        autocomplete="tel"
        inputmode="tel"
        required
      />
      <div class="info">Usado para suporte e comunicação</div>

      <button id="checkout-submit" type="submit">
        {{ "Continuar para ativar grátis" if is_free_plan else "Continuar para pagamento" }}
      </button>
    </form>

    {% include "_shared_footer.html" %}
  </div>

  <script>
    // Ping simples para métricas (não bloqueia navegação)
    async function pingOnline() {
      try { await fetch('/online/ping', { method: 'POST' }); } catch (e) {}
    }
    pingOnline();
    setInterval(pingOnline, 30000);

    // ===== Fallback anti-interceptação =====
    // Se algum JS global interceptar o submit (transformar em fetch/xhr),
    // este código tenta pegar JSON do backend e redirecionar manualmente.
    (function () {
      const form = document.getElementById('checkout-form');
      const btn  = document.getElementById('checkout-submit');
      if (!form || !btn) return;

      let attemptedFallback = false;

      form.addEventListener('submit', function () {
        // Se for navegação normal, a página troca e este JS "some".
        // Se a página não trocar rapidamente (submit interceptado), ativamos fallback.
        btn.disabled = true;

        setTimeout(async () => {
          if (attemptedFallback) return;
          attemptedFallback = true;

          try {
            const fd = new FormData(form);

            const resp = await fetch(form.action, {
              method: "POST",
              body: fd,
              headers: {
                "Accept": "application/json",
                "X-Requested-With": "XMLHttpRequest"
              },
              credentials: "same-origin"
            });

            if (!resp.ok) {
              const txt = await resp.text();
              alert(txt || "Não foi possível continuar. Tente novamente.");
              btn.disabled = false;
              return;
            }

            const data = await resp.json();
            if (data && data.checkout_url) {
              window.location.href = data.checkout_url;
              return;
            }

            alert("Não foi possível gerar o checkout. Tente novamente.");
            btn.disabled = false;
          } catch (e) {
            alert("Falha ao continuar. Verifique sua conexão e tente novamente.");
            btn.disabled = false;
          }
        }, 350);
      }, true);
    })();
  </script>
</body>
</html>
