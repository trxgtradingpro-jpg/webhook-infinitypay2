<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Conta | TRX PRO</title>
  <link rel="shortcut icon" href="/favicon.ico?v=4" type="image/x-icon">
  <link rel="icon" href="/assets/favicons/favicon_16.png?v=4" type="image/png" sizes="16x16">
  <link rel="icon" href="/assets/favicons/favicon_32.png?v=4" type="image/png" sizes="32x32">
  <link rel="icon" href="/assets/favicons/favicon_64.png?v=4" type="image/png" sizes="64x64">
  <link rel="apple-touch-icon" href="/assets/favicons/favicon_256.png?v=4">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#05070a;
      --bg2:#070b12;
      --txt:#eef6ff;
      --muted:rgba(238,246,255,.68);
      --muted2:rgba(238,246,255,.55);
      --line:rgba(255,255,255,.12);
      --line2:rgba(255,255,255,.18);
      --green:#23b00b;
      --green2:#1d8f09;
      --red:#ff3a3a;
      --blue:#4aa3ff;
      --warn:#ffd21a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--txt);
      background:
        radial-gradient(1100px 650px at 20% 8%, rgba(35,176,11,.18), transparent 58%),
        radial-gradient(900px 600px at 80% 18%, rgba(255,138,31,.12), transparent 62%),
        radial-gradient(900px 700px at 60% 86%, rgba(168,85,247,.10), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 50%, var(--bg) 100%);
      overflow-x:hidden;
    }
    .grid-bg{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.16;
      background:
        linear-gradient(to right, rgba(255,255,255,.09) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.09) 1px, transparent 1px);
      background-size:64px 64px;
      mask-image:radial-gradient(circle at 50% 18%, rgba(0,0,0,1) 0%, rgba(0,0,0,.65) 45%, rgba(0,0,0,0) 76%);
    }
    .vignette{
      position:fixed; inset:-40px;
      pointer-events:none;
      background:radial-gradient(circle at 50% 22%, transparent 0%, rgba(0,0,0,.35) 55%, rgba(0,0,0,.75) 90%);
    }
    .aurora-bg{
      position:fixed;
      inset:-18%;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
      opacity:.78;
      filter:saturate(1.08);
    }
    .aurora-blob{
      position:absolute;
      width:min(62vw, 820px);
      min-width:320px;
      aspect-ratio:1/1;
      border-radius:999px;
      filter:blur(92px);
      mix-blend-mode:screen;
      opacity:.26;
      transform:translate3d(0,0,0);
      will-change:transform;
    }
    .aurora-blob.a{
      top:-16%;
      left:-8%;
      background:radial-gradient(circle at 36% 34%, rgba(35,176,11,.46), rgba(35,176,11,.12) 50%, transparent 74%);
      animation:auroraDriftA 24s ease-in-out infinite alternate;
    }
    .aurora-blob.b{
      top:8%;
      right:-22%;
      background:radial-gradient(circle at 44% 40%, rgba(74,163,255,.42), rgba(74,163,255,.12) 52%, transparent 76%);
      animation:auroraDriftB 30s ease-in-out infinite alternate;
      animation-delay:-7s;
    }
    .aurora-blob.c{
      bottom:-24%;
      left:18%;
      background:radial-gradient(circle at 50% 44%, rgba(255,138,31,.34), rgba(240,90,26,.09) 50%, transparent 76%);
      animation:auroraDriftC 34s ease-in-out infinite alternate;
      animation-delay:-12s;
    }
    @keyframes auroraDriftA{
      0%{ transform:translate3d(-4%, -1%, 0) scale(1); }
      50%{ transform:translate3d(8%, -6%, 0) scale(1.08); }
      100%{ transform:translate3d(-2%, 9%, 0) scale(.96); }
    }
    @keyframes auroraDriftB{
      0%{ transform:translate3d(1%, -3%, 0) scale(.98); }
      50%{ transform:translate3d(-8%, 6%, 0) scale(1.10); }
      100%{ transform:translate3d(5%, -2%, 0) scale(.95); }
    }
    @keyframes auroraDriftC{
      0%{ transform:translate3d(0, 3%, 0) scale(1); }
      50%{ transform:translate3d(-7%, -7%, 0) scale(1.07); }
      100%{ transform:translate3d(6%, 5%, 0) scale(.94); }
    }
    @media (prefers-reduced-motion: reduce){
      .aurora-blob{
        animation:none !important;
        opacity:.18;
      }
    }
    .wrap{
      position:relative;
      z-index:2;
      width:min(1120px, 92vw);
      margin:20px auto 28px;
      display:grid;
      gap:14px;
    }
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(8,13,18,.88), rgba(6,9,14,.92));
      box-shadow:0 18px 50px rgba(0,0,0,.34);
    }
    .title{
      font-size:30px;
      letter-spacing:-.5px;
      font-weight:1000;
      margin:0;
      text-transform:uppercase;
    }
    .subtitle{
      margin:4px 0 0;
      color:var(--muted);
      font-size:14px;
      font-weight:700;
    }
    .msg{
      margin:0;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      font-size:14px;
      line-height:1.4;
      background:rgba(255,255,255,.03);
      box-shadow:0 12px 30px rgba(0,0,0,.18);
    }
    .msg.ok{
      border-color:rgba(35,176,11,.42);
      background:rgba(35,176,11,.12);
      color:#b9ffd3;
    }
    .logout{
      border:1px solid rgba(255,58,58,.56);
      border-radius:12px;
      background:linear-gradient(180deg, rgba(255,58,58,.26), rgba(255,58,58,.12));
      color:#ffd4d4;
      font-weight:900;
      letter-spacing:.2px;
      padding:10px 14px;
      cursor:pointer;
      transition:.16s transform, .16s filter;
    }
    .logout:hover{ transform:translateY(-1px); filter:brightness(1.06); }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns:1fr; }
    }
    .card{
      position:relative;
      overflow:hidden;
      border-radius:16px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(8,13,18,.88), rgba(6,9,14,.92));
      box-shadow:0 24px 80px rgba(0,0,0,.42);
      padding:16px;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:radial-gradient(760px 220px at 18% 0%, rgba(35,176,11,.12), transparent 62%);
      pointer-events:none;
    }
    .card > *{
      position:relative;
      z-index:1;
    }
    h2{
      margin:0 0 10px;
      font-size:20px;
      letter-spacing:-.3px;
      font-weight:900;
    }
    .line{
      margin:7px 0;
      color:#dbe7ff;
      font-size:14px;
      font-weight:700;
    }
    .line span{
      color:var(--muted);
      display:inline-block;
      min-width:95px;
      font-weight:800;
    }
    .kpi{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chart-wrap{
      width:100%;
      height:360px;
      margin-top:12px;
      position:relative;
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px;
      background:rgba(0,0,0,.22);
    }
    .chart-hint{
      margin-top:10px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.4;
      font-weight:700;
    }
    .chart-window-controls{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chart-config-row{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .chart-config-row .chart-window-controls{
      margin-top:0;
      flex:1 1 460px;
    }
    .chart-contract-control{
      display:grid;
      gap:6px;
      min-width:220px;
    }
    .chart-contract-control label{
      font-size:12px;
      font-weight:900;
      color:#b9c8e8;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .chart-contract-input-wrap{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .chart-contract-input{
      width:96px;
      border:1px solid var(--line2);
      border-radius:10px;
      background:rgba(255,255,255,.04);
      color:#e9f3ff;
      padding:7px 10px;
      font-size:14px;
      font-weight:900;
      outline:none;
      transition:.16s border-color, .16s box-shadow, .16s filter;
    }
    .chart-contract-input:hover{
      filter:brightness(1.06);
    }
    .chart-contract-input:focus{
      border-color:rgba(35,176,11,.62);
      box-shadow:0 0 0 2px rgba(35,176,11,.20);
    }
    .chart-contract-input[disabled]{
      opacity:.65;
      cursor:not-allowed;
    }
    .chart-contract-limit{
      border:1px solid rgba(35,176,11,.42);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(35,176,11,.14);
      color:#b9ffd3;
      font-size:11px;
      font-weight:900;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .chart-mode-btn{
      border:1px solid var(--line2);
      border-radius:999px;
      background:rgba(255,255,255,.04);
      color:#e9f3ff;
      padding:7px 11px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      transition:.16s transform, .16s filter, .16s border-color;
    }
    .chart-mode-btn:hover{
      transform:translateY(-1px);
      filter:brightness(1.06);
      border-color:rgba(74,163,255,.62);
    }
    .chart-mode-btn.is-active{
      border-color:rgba(35,176,11,.58);
      background:rgba(35,176,11,.18);
      color:#b9ffd3;
    }
    .pill{
      border:1px solid var(--line2);
      border-radius:999px;
      padding:7px 10px;
      background:rgba(255,255,255,.04);
      color:#e9f3ff;
      font-size:12px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .pill.ok{
      border-color:rgba(35,176,11,.50);
      background:rgba(35,176,11,.15);
      color:#b9ffd3;
    }
    .pill.warn{
      border-color:rgba(255,210,26,.55);
      background:rgba(255,210,26,.14);
      color:#ffe79b;
    }
    .pill strong{
      color:#f2f8ff;
    }
    .pill.bad{
      border-color:rgba(255,58,58,.52);
      background:rgba(255,58,58,.14);
      color:#ffd4d4;
    }
    .table-wrap{
      overflow-x:auto;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,.18);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:780px;
    }
    th,td{
      padding:11px 10px;
      text-align:left;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:13px;
      font-weight:700;
    }
    th{
      color:var(--muted);
      font-weight:900;
      background:rgba(255,255,255,.03);
      letter-spacing:.2px;
    }
    tbody tr:hover{
      background:rgba(255,255,255,.03);
    }
    td strong{
      font-size:13px;
    }
    .status{
      display:inline-block;
      border-radius:999px;
      padding:5px 8px;
      font-size:11px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .status.ok{
      color:#bbf7d0;
      background:rgba(35,176,11,.18);
      border:1px solid rgba(35,176,11,.42);
    }
    .status.bad{
      color:#ffd2d2;
      background:rgba(255,58,58,.18);
      border:1px solid rgba(255,58,58,.42);
    }
    .empty{
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
      font-weight:700;
    }
    .back{
      width:fit-content;
      color:#eaf4ff;
      text-decoration:none;
      font-size:13px;
      font-weight:900;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.04);
      border-radius:12px;
      padding:9px 12px;
      transition:.16s transform, .16s filter;
    }
    .back:hover{ transform:translateY(-1px); filter:brightness(1.08); }
    .upsell-intro{
      margin:0;
      color:#dbe7ff;
      font-size:14px;
      line-height:1.5;
      font-weight:700;
    }
    .upsell-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(210px, 1fr));
      gap:12px;
      margin-top:12px;
    }
    .upsell-card{
      --card-border:rgba(74,163,255,.44);
      --card-top:rgba(11,20,40,.96);
      --card-bottom:rgba(8,14,30,.98);
      --card-shine:rgba(74,163,255,.16);
      --card-tag-bg:rgba(74,163,255,.16);
      --card-tag-border:rgba(74,163,255,.52);
      --card-tag-color:#c9ecff;
      --card-price:#ecf2ff;
      --card-cta:#90ffd4;
      position:relative;
      overflow:hidden;
      display:block;
      border:1px solid var(--card-border);
      border-radius:14px;
      padding:12px;
      text-decoration:none;
      background:linear-gradient(180deg, var(--card-top), var(--card-bottom));
      color:#ecf3ff;
      transition:transform .16s ease, border-color .16s ease, box-shadow .16s ease, filter .16s ease;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.08), 0 10px 30px rgba(0,0,0,.24);
    }
    .upsell-card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:radial-gradient(420px 170px at 10% 0%, var(--card-shine), transparent 68%);
      pointer-events:none;
      opacity:.95;
    }
    .upsell-card > *{
      position:relative;
      z-index:1;
    }
    .upsell-card:hover{
      transform:translateY(-2px);
      filter:brightness(1.05);
      border-color:rgba(116,199,255,.66);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 14px 34px rgba(25,86,160,.30);
    }
    .upsell-card.plan-bronze{
      --card-border:rgba(255,138,31,.52);
      --card-top:rgba(36,18,4,.96);
      --card-bottom:rgba(21,11,3,.98);
      --card-shine:rgba(255,138,31,.20);
      --card-tag-bg:rgba(255,138,31,.18);
      --card-tag-border:rgba(255,138,31,.48);
      --card-tag-color:#ffd4b0;
      --card-price:#ffbc67;
    }
    .upsell-card.plan-prata{
      --card-border:rgba(198,212,235,.52);
      --card-top:rgba(22,30,46,.96);
      --card-bottom:rgba(12,18,30,.98);
      --card-shine:rgba(198,212,235,.18);
      --card-tag-bg:rgba(198,212,235,.18);
      --card-tag-border:rgba(198,212,235,.50);
      --card-tag-color:#deebff;
      --card-price:#dbe6f6;
    }
    .upsell-card.plan-gold{
      --card-border:rgba(255,210,26,.52);
      --card-top:rgba(36,27,4,.96);
      --card-bottom:rgba(19,13,2,.98);
      --card-shine:rgba(255,210,26,.18);
      --card-tag-bg:rgba(255,210,26,.18);
      --card-tag-border:rgba(255,210,26,.52);
      --card-tag-color:#ffe89a;
      --card-price:#ffe26a;
    }
    .upsell-card.plan-black{
      --card-border:rgba(207,164,255,.52);
      --card-top:rgba(28,12,46,.96);
      --card-bottom:rgba(16,6,28,.98);
      --card-shine:rgba(207,164,255,.20);
      --card-tag-bg:rgba(207,164,255,.17);
      --card-tag-border:rgba(207,164,255,.52);
      --card-tag-color:#e6d0ff;
      --card-price:#ddc0ff;
    }
    .upsell-card.recommended{
      border-color:rgba(35,176,11,.66);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10), 0 14px 36px rgba(20,97,72,.34);
    }
    .upsell-card.recommended::after{
      content:"";
      position:absolute;
      inset:auto -18% -42% -18%;
      height:68%;
      background:radial-gradient(440px 170px at 50% 0%, rgba(35,176,11,.22), transparent 74%);
      pointer-events:none;
    }
    .upsell-card .tag{
      display:inline-block;
      margin-bottom:8px;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      font-weight:900;
      background:var(--card-tag-bg);
      border:1px solid var(--card-tag-border);
      color:var(--card-tag-color);
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .upsell-card.recommended .tag{
      background:rgba(35,176,11,.18);
      border-color:rgba(35,176,11,.52);
      color:#bbf7d0;
    }
    .upsell-name{
      margin:0;
      font-size:32px;
      font-weight:1000;
      line-height:.92;
      letter-spacing:-.8px;
      text-transform:uppercase;
    }
    .upsell-contracts{
      margin:6px 0 0;
      font-size:12px;
      font-weight:800;
      color:#c9daef;
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .upsell-price{
      margin:14px 0 0;
      font-size:40px;
      font-weight:1000;
      line-height:.92;
      letter-spacing:-.9px;
      color:var(--card-price);
    }
    .upsell-price .rs{
      font-size:20px;
      margin-right:2px;
    }
    .upsell-price small{
      font-size:16px;
      color:#d9e6fa;
      font-weight:800;
      margin-left:4px;
      letter-spacing:.1px;
    }
    .upsell-cta{
      margin-top:12px;
      font-size:12px;
      font-weight:900;
      color:var(--card-cta);
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    .upsell-note{
      margin-top:10px;
      color:var(--muted2);
      font-size:12px;
      font-weight:700;
    }
  </style>
</head>
<body>
  <div class="aurora-bg" aria-hidden="true">
    <span class="aurora-blob a"></span>
    <span class="aurora-blob b"></span>
    <span class="aurora-blob c"></span>
  </div>
  <div class="grid-bg" aria-hidden="true"></div>
  <div class="vignette" aria-hidden="true"></div>
  <main class="wrap">
    <header class="top">
      <div>
        <h1 class="title">Minha Conta</h1>
        <p class="subtitle">Bem-vindo, {{ conta_nome or 'Cliente' }}.</p>
      </div>
      <form method="POST" action="/logout">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button class="logout" type="submit">Sair</button>
      </form>
    </header>
    {% if info_message %}
      <div class="msg ok">{{ info_message }}</div>
    {% endif %}

    <section class="grid">
      <article class="card">
        <h2>Dados do cliente</h2>
        <p class="line"><span>Nome:</span> {{ conta_nome or '-' }}</p>
        <p class="line"><span>E-mail:</span> {{ email }}</p>
        <p class="line"><span>Telefone:</span> {{ conta.telefone or '-' }}</p>
        <p class="line"><span>Conta criada:</span> {{ conta.created_at.strftime("%d/%m/%Y %H:%M") if conta.created_at else '-' }}</p>
      </article>

      <article class="card">
        <h2>Status dos planos</h2>
        <div class="kpi">
          <span class="pill">Total liberado: {{ pedidos|length }}</span>
          <span class="pill ok">Ativos: {{ ativos|length }}</span>
          <span class="pill warn">Expirados: {{ (pedidos|length) - (ativos|length) }}</span>
        </div>
        {% if ultimo_pedido %}
          <p class="line" style="margin-top:10px;"><span>Plano mais recente:</span> <strong>{{ ultimo_pedido.plano_nome }}</strong></p>
          <p class="line"><span>Expira em:</span> {{ ultimo_pedido.expira_em_fmt }}</p>
        {% else %}
          <p class="empty">Nenhum plano encontrado para este e-mail.</p>
        {% endif %}
      </article>
    </section>

    <section class="card">
      <h2>Crescimento do capital</h2>
      {% if capital_chart and capital_chart.available %}
        <p class="line"><span>Plano:</span> {{ capital_chart.plan_name }}</p>
        <p class="line"><span>Periodo do plano:</span> {{ capital_chart.start_date }} ate {{ capital_chart.end_date }}</p>
        <p class="line"><span>Periodo do CSV:</span> {{ capital_chart.start_date }} ate {{ capital_chart.csv_end_date }}</p>
        <p class="line"><span>Janela exibida:</span> <strong id="windowRangeText">{{ capital_chart.window_start_date or capital_chart.start_date }} ate {{ capital_chart.window_end_date or capital_chart.end_date }}</strong></p>
        <div class="kpi" style="margin-top:8px;">
          <span class="pill">Dias do plano: {{ capital_chart.plan_days }}</span>
          <span class="pill">Dias no CSV: {{ capital_chart.csv_last_day }}</span>
          <span class="pill ok">Dia atual: {{ capital_chart.current_day }}</span>
          <span class="pill">Contratos no grafico: <strong id="contractsSelected">{{ capital_chart.contract_default or 1 }}</strong> / {{ capital_chart.contract_limit or 1 }}</span>
          <span class="pill">Valor atual: <strong id="currentValueText">R$ {{ "{:,.2f}".format(capital_chart.current_value).replace(",", "X").replace(".", ",").replace("X", ".") }}</strong></span>
          <span class="pill">Saldo total no CSV: <strong id="csvTotalValueText">R$ {{ "{:,.2f}".format(capital_chart.csv_total_value).replace(",", "X").replace(".", ",").replace("X", ".") }}</strong></span>
        </div>
        <div class="chart-config-row">
          {% if capital_chart.window_modes %}
          <div class="chart-window-controls">
            {% for mode_id, mode in capital_chart.window_modes.items() %}
              <button
                type="button"
                class="chart-mode-btn {{ 'is-active' if mode_id == (capital_chart.default_window_mode or 'back15_forward15') else '' }}"
                data-chart-mode="{{ mode_id }}"
              >
                {{ mode.title }}
              </button>
            {% endfor %}
          </div>
          {% endif %}
          <div class="chart-contract-control">
            <label for="contractCountInput">Quantidade de contratos</label>
            <div class="chart-contract-input-wrap">
              <input
                id="contractCountInput"
                class="chart-contract-input"
                type="number"
                min="1"
                max="{{ capital_chart.contract_limit or 1 }}"
                step="1"
                value="{{ capital_chart.contract_default or 1 }}"
                {% if (capital_chart.contract_limit or 1) <= 1 %}disabled{% endif %}
              >
              <span class="chart-contract-limit">Limite: {{ capital_chart.contract_limit or 1 }}</span>
            </div>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="capitalChart"></canvas>
        </div>
        <p class="chart-hint" id="chartHintText">Passe o mouse sobre a linha para ver a data e o valor do dia.</p>
      {% else %}
        <p class="empty">{{ capital_chart.message if capital_chart else 'Curva indisponivel no momento.' }}</p>
        <p class="empty">CSV esperado: <code>dia,valor</code> (ex.: <code>1,10000</code> ... <code>30,12800</code>).</p>
      {% endif %}
    </section>

    {% if upsell_plans %}
    <section class="card">
      <h2>Evolua para um plano pago</h2>
      <p class="upsell-intro">
        Seu acesso gratuito esta ativo. Para liberar mais recursos e suporte completo, escolha um plano abaixo.
      </p>
      <div class="upsell-grid">
        {% for plano in upsell_plans %}
          <a
            class="upsell-card js-upsell-link {{ plano.theme_class }} {{ 'recommended' if plano.is_most_chosen else '' }}"
            href="/checkout/{{ plano.checkout_slug }}"
            data-upgrade-plan="{{ plano.plano_id }}"
            data-upgrade-source="client_area_free_upsell"
          >
            <span class="tag">{{ plano.tag_text }}</span>
            <p class="upsell-name">{{ plano.nome }}</p>
            <p class="upsell-contracts">{{ plano.contracts_text }}</p>
            <p class="upsell-price">{{ plano.preco_fmt }}<small>/mes</small></p>
            <p class="upsell-cta">Clique para ir ao checkout</p>
          </a>
        {% endfor %}
      </div>
      <p class="upsell-note">Ao clicar, voce sera direcionado para o checkout do plano selecionado.</p>
    </section>
    {% endif %}

    <section class="card">
      <h2>Historico de acessos liberados</h2>
      {% if pedidos %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Pedido</th>
                <th>Plano</th>
                <th>Liberado em</th>
                <th>Expira em</th>
                <th>Status</th>
                <th>Dias restantes</th>
              </tr>
            </thead>
            <tbody>
              {% for p in pedidos %}
              <tr>
                <td><code>{{ p.order_id[:8] }}...</code></td>
                <td>
                  <strong>{{ p.plano_nome }}</strong><br>
                  <span style="color:#9db0d4;">{{ 'Pago' if p.is_paid else 'Gratuito' }}</span>
                </td>
                <td>{{ p.created_at_fmt }}</td>
                <td>{{ p.expira_em_fmt }}</td>
                <td>
                  {% if p.ativo %}
                    <span class="status ok">Ativo</span>
                  {% else %}
                    <span class="status bad">Expirado</span>
                  {% endif %}
                </td>
                <td>
                  {% if p.ativo %}
                    {{ p.dias_restantes }} dia(s)
                  {% else %}
                    0
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="empty">Ainda nao encontramos planos ativos para esta conta.</p>
      {% endif %}
    </section>

    <a class="back" href="/">Voltar para a pagina inicial</a>
  </main>

  {% if capital_chart and capital_chart.available %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      (function(){
        const payload = {{ capital_chart | tojson }};
        const canvas = document.getElementById("capitalChart");
        if (!payload || !payload.available || !canvas) return;

        const fmtBRL = new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL"
        });
        const windowModes = payload.window_modes || {};
        const fallbackModeData = {
          id: "fallback",
          title: "Janela atual",
          description: "",
          window_start_date: payload.window_start_date,
          window_end_date: payload.window_end_date,
          labels: payload.labels || [],
          date_labels: payload.date_labels || [],
          values: payload.values || [],
          y_min: payload.y_min,
          y_max: payload.y_max
        };
        const modeIds = Object.keys(windowModes);
        let activeMode = payload.default_window_mode;
        if (!activeMode || !windowModes[activeMode]) {
          activeMode = modeIds.length ? modeIds[0] : "fallback";
        }

        const modeButtons = Array.from(document.querySelectorAll(".chart-mode-btn[data-chart-mode]"));
        const windowRangeText = document.getElementById("windowRangeText");
        const chartHintText = document.getElementById("chartHintText");
        const contractsSelectedEl = document.getElementById("contractsSelected");
        const currentValueTextEl = document.getElementById("currentValueText");
        const csvTotalValueTextEl = document.getElementById("csvTotalValueText");
        const contractInput = document.getElementById("contractCountInput");
        const contractLimit = Math.max(1, Number.parseInt(payload.contract_limit || 1, 10) || 1);
        const axisPaddingBase = Math.max(0, Number(payload.axis_padding_base || 100));
        let activeContracts = Math.max(1, Math.min(
          contractLimit,
          Number.parseInt(payload.contract_default || 1, 10) || 1
        ));

        function getModeData(modeId) {
          return windowModes[modeId] || fallbackModeData;
        }

        function roundTo2(value) {
          return Math.round((Number(value) + Number.EPSILON) * 100) / 100;
        }

        function normalizeContract(value) {
          const parsed = Number.parseInt(value, 10);
          if (!Number.isFinite(parsed)) return 1;
          return Math.max(1, Math.min(contractLimit, parsed));
        }

        function scaleValues(values) {
          return (values || []).map((value) => {
            if (value === null || value === undefined) {
              return null;
            }
            return roundTo2(Number(value) * activeContracts);
          });
        }

        function calculateYBounds(values) {
          const visibles = (values || []).filter((value) => Number.isFinite(value));
          const fallbackCurrent = roundTo2((Number(payload.current_value) || 0) * activeContracts);
          const baseValues = visibles.length ? visibles : [fallbackCurrent];
          const minimo = Math.min(...baseValues);
          const maximo = Math.max(...baseValues);
          const padding = axisPaddingBase * Math.max(1, activeContracts);

          let yMin = minimo - padding;
          let yMax = maximo + padding;

          if (Math.abs(yMax - yMin) < 0.01) {
            const fallbackPadding = padding || 100;
            yMin -= fallbackPadding;
            yMax += fallbackPadding;
          }

          return {
            y_min: roundTo2(yMin),
            y_max: roundTo2(yMax),
          };
        }

        function getScaledModeData(modeData) {
          const scaledValues = scaleValues(modeData.values || []);
          const yBounds = calculateYBounds(scaledValues);
          return {
            ...modeData,
            values: scaledValues,
            y_min: yBounds.y_min,
            y_max: yBounds.y_max,
          };
        }

        function countVisibleValues(values) {
          return (values || []).filter((value) => Number.isFinite(value)).length;
        }

        function getPointRadius(values) {
          return countVisibleValues(values) <= 1 ? 4 : 0;
        }

        function refreshContractIndicators() {
          if (contractsSelectedEl) {
            contractsSelectedEl.textContent = String(activeContracts);
          }
          if (currentValueTextEl) {
            const currentValue = (Number(payload.current_value) || 0) * activeContracts;
            currentValueTextEl.textContent = fmtBRL.format(currentValue);
          }
          if (csvTotalValueTextEl) {
            const csvTotalValue = (Number(payload.csv_total_value) || 0) * activeContracts;
            csvTotalValueTextEl.textContent = fmtBRL.format(csvTotalValue);
          }
          if (contractInput) {
            contractInput.value = String(activeContracts);
          }
        }

        function getHintText(modeData) {
          if (!modeData) {
            return "Passe o mouse sobre a linha para ver a data e o valor do dia.";
          }
          if (modeData.id === "back30") {
            return "Janela de 30 dias anteriores. O dia atual fica no fim do grafico. Contratos aplicados: " + activeContracts + ".";
          }
          return "Janela de 15 dias para tras e 15 para frente. Dias futuros ficam sem curva. Contratos aplicados: " + activeContracts + ".";
        }

        const initialModeData = getScaledModeData(getModeData(activeMode));
        const initialPointRadius = getPointRadius(initialModeData.values);

        const crosshairPlugin = {
          id: "crosshairPlugin",
          afterDatasetsDraw(chart) {
            const active = chart.tooltip && chart.tooltip.getActiveElements
              ? chart.tooltip.getActiveElements()
              : [];
            if (!active || !active.length) return;

            const ctx = chart.ctx;
            const area = chart.chartArea;
            const point = active[0].element;
            const x = point.x;
            const y = point.y;

            ctx.save();
            ctx.strokeStyle = "rgba(116, 255, 214, 0.8)";
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);

            ctx.beginPath();
            ctx.moveTo(x, area.top);
            ctx.lineTo(x, area.bottom);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(area.left, y);
            ctx.lineTo(area.right, y);
            ctx.stroke();
            ctx.restore();
          }
        };

        const chart = new Chart(canvas, {
          type: "line",
          data: {
            labels: initialModeData.labels || [],
            datasets: [{
              label: "Capital (1 contrato)",
              data: initialModeData.values || [],
              borderColor: "#74ffd6",
              backgroundColor: "rgba(57, 201, 145, 0.28)",
              fill: true,
              tension: 0.28,
              borderWidth: 2,
              pointRadius: initialPointRadius,
              pointHoverRadius: initialPointRadius > 0 ? 7 : 4,
              pointHitRadius: initialPointRadius > 0 ? 12 : 6,
              pointHoverBackgroundColor: "#74ffd6",
              pointHoverBorderColor: "#0f2d24"
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                displayColors: false,
                callbacks: {
                  title(items) {
                    if (!items || !items.length) return "";
                    const idx = items[0].dataIndex;
                    const modeData = getModeData(activeMode);
                    const dateLabel = (modeData.date_labels || [])[idx] || "";
                    const dayLabel = (modeData.labels || [])[idx] || "";
                    return dateLabel + " (Dia " + dayLabel + ")";
                  },
                  label(context) {
                    const valor = Number(context.parsed.y);
                    if (!Number.isFinite(valor)) {
                      return "Sem curva para esse dia.";
                    }
                    const sufixo = activeContracts > 1 ? "s" : "";
                    return "Capital (" + activeContracts + " contrato" + sufixo + "): " + fmtBRL.format(valor);
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  color: "rgba(120, 142, 184, 0.18)"
                },
                ticks: {
                  color: "#9db0d4",
                  maxTicksLimit: 10
                },
                title: {
                  display: true,
                  text: "Dias do plano",
                  color: "#9db0d4"
                }
              },
              y: {
                min: initialModeData.y_min ?? payload.y_min,
                max: initialModeData.y_max ?? payload.y_max,
                grid: {
                  color: "rgba(120, 142, 184, 0.18)"
                },
                ticks: {
                  color: "#9db0d4",
                  callback(value) {
                    return fmtBRL.format(value);
                  }
                },
                title: {
                  display: true,
                  text: "Capital acumulado (R$)",
                  color: "#9db0d4"
                }
              }
            }
          },
          plugins: [crosshairPlugin]
        });

        function applyMode(modeId) {
          const modeData = getScaledModeData(getModeData(modeId));
          activeMode = modeId;

          chart.data.labels = modeData.labels || [];
          chart.data.datasets[0].label = "Capital (" + activeContracts + " contrato" + (activeContracts > 1 ? "s" : "") + ")";
          chart.data.datasets[0].data = modeData.values || [];
          const pointRadius = getPointRadius(modeData.values);
          chart.data.datasets[0].pointRadius = pointRadius;
          chart.data.datasets[0].pointHoverRadius = pointRadius > 0 ? 7 : 4;
          chart.data.datasets[0].pointHitRadius = pointRadius > 0 ? 12 : 6;
          chart.options.scales.y.min = modeData.y_min ?? payload.y_min;
          chart.options.scales.y.max = modeData.y_max ?? payload.y_max;
          chart.update();

          if (windowRangeText) {
            const startDate = modeData.window_start_date || payload.window_start_date || payload.start_date || "";
            const endDate = modeData.window_end_date || payload.window_end_date || payload.end_date || "";
            windowRangeText.textContent = startDate + " ate " + endDate;
          }
          if (chartHintText) {
            chartHintText.textContent = getHintText(modeData);
          }
          refreshContractIndicators();

          modeButtons.forEach((btn) => {
            btn.classList.toggle("is-active", (btn.getAttribute("data-chart-mode") || "") === modeId);
          });
        }

        modeButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const modeId = (btn.getAttribute("data-chart-mode") || "").trim();
            if (!modeId) return;
            applyMode(modeId);
          });
        });

        if (contractInput) {
          contractInput.addEventListener("change", () => {
            const nextContracts = normalizeContract(contractInput.value);
            if (nextContracts === activeContracts) {
              contractInput.value = String(activeContracts);
              return;
            }
            activeContracts = nextContracts;
            applyMode(activeMode);
          });

          contractInput.addEventListener("blur", () => {
            contractInput.value = String(normalizeContract(contractInput.value));
          });
        }

        refreshContractIndicators();
        applyMode(activeMode);
      })();
    </script>
  {% endif %}

  {% if upsell_plans %}
    <script>
      (function(){
        const links = document.querySelectorAll(".js-upsell-link[data-upgrade-plan]");
        if (!links.length) return;

        const csrfToken = "{{ csrf_token }}";
        const endpoint = "/api/client/lead-upgrade-click";

        function registrarLead(targetPlan, source){
          return fetch(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfToken
            },
            credentials: "same-origin",
            keepalive: true,
            body: JSON.stringify({
              target_plan: targetPlan,
              source: source || "client_area_free_upsell"
            })
          });
        }

        links.forEach((link) => {
          link.addEventListener("click", function(event){
            const targetPlan = link.getAttribute("data-upgrade-plan") || "";
            const source = link.getAttribute("data-upgrade-source") || "client_area_free_upsell";
            const href = link.getAttribute("href") || "/";

            if (!targetPlan) return;

            if (
              event.defaultPrevented ||
              event.button !== 0 ||
              event.metaKey ||
              event.ctrlKey ||
              event.shiftKey ||
              event.altKey
            ) {
              registrarLead(targetPlan, source).catch(() => null);
              return;
            }

            event.preventDefault();
            let redirected = false;
            const goCheckout = function(){
              if (redirected) return;
              redirected = true;
              window.location.href = href;
            };

            const fallback = setTimeout(goCheckout, 220);
            registrarLead(targetPlan, source)
              .catch(() => null)
              .finally(() => {
                clearTimeout(fallback);
                goCheckout();
              });
          });
        });
      })();
    </script>
  {% endif %}
</body>
</html>
